<script>
  const slug = new URLSearchParams(window.location.search).get("slug");

  async function nactiDetailProduktu() {
    const apiUrl = "https://api.github.com/repos/czepepe-dev/solarcity/contents/data/productos";
    const files = await fetch(apiUrl).then(r => r.json());

    let jsonFiles = files.filter(f => f.name.endsWith(".json")).map(f => f.name);

    for (const file of jsonFiles) {
      const data = await fetch(`/data/productos/${file}`).then(r => r.json());

      if (!data.slug) {
        data.slug = data.nombre
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
      }

      if (data.slug === slug) {
        zobrazProdukt(data);
        return;
      }
    }

    document.querySelector(".product-page").innerHTML =
      "<p>Producto no encontrado.</p>";
  }

  async function zobrazProdukt(p) {

    document.getElementById("p-img").src = p.imagen;
    document.getElementById("p-nazev").textContent = p.nombre;
    document.getElementById("p-cena").textContent = p.precio;

    let popis = p.descripcion
      .replace(/<!--StartFragment-->/g, "")
      .replace(/<!--EndFragment-->/g, "")
      .trim();

    document.getElementById("p-popis").innerHTML = marked.parse(popis);

    document.querySelectorAll("#p-popis img").forEach(img => {
      img.style.cursor = "pointer";
      img.onclick = () => openLightbox(img.src);
    });

    /* -------------------------------
       NOVÁ GALERIE Z JSONU
    --------------------------------*/
    const gal = document.getElementById("galerie");
    gal.innerHTML = "";

    if (Array.isArray(p.galeria) && p.galeria.length > 0) {
      p.galeria.forEach(item => {
        gal.innerHTML += `
          <img src="${item.imagen}" loading="lazy" onclick="openLightbox('${item.imagen}')">
        `;
      });
    }
  }

  /* --- LIGHTBOX FUNKCE S ANIMACÍ --- */
  function openLightbox(src) {
    const lb = document.getElementById("lightbox");
    const img = document.getElementById("lightbox-img");

    img.src = src;
    lb.style.display = "flex";

    setTimeout(() => lb.classList.add("show"), 10);
  }

  function closeLightbox() {
    const lb = document.getElementById("lightbox");
    lb.classList.remove("show");

    setTimeout(() => {
      lb.style.display = "none";
    }, 250);
  }

  nactiDetailProduktu();
</script>
